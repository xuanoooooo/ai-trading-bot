# 修复记录 v2.4.9

**发布日期**: 2025-01-XX  
**版本**: v2.4.9

## 🎯 主要功能

### ✅ 新增：OpenRouter AI模型支持 + 智能API Key检测

本次更新让系统支持多种AI模型提供商，并实现了智能API Key检测机制，使配置更加简单灵活。

---

## 📋 详细更新内容

### 1. 新增AI模型配置系统

**配置文件**: `config/coins_config.json`

新增 `ai_config` 配置项，支持配置：
- AI提供商（provider）
- 模型名称（model）
- API地址（api_base）
- API Key环境变量名（api_key_env）
- 温度参数（temperature）
- 最大Token数（max_tokens）

**支持的AI提供商**：
- DeepSeek（默认，性价比高）
- OpenRouter（统一接口，支持多种模型）
- OpenAI（GPT系列）
- Qwen（通义千问，适合国内网络）

### 2. 智能API Key检测机制

**代码改进**: `src/portfolio_manager.py`

实现智能API Key检测逻辑：
- ✅ 优先使用配置文件中指定的API Key
- ✅ 自动Fallback：配置的Key不存在时自动检测其他可用Key
- ✅ 友好提示：明确显示正在使用哪个API Key
- ✅ 错误处理：没有任何可用Key时给出清晰的错误提示

**检测顺序**：
1. DEEPSEEK_API_KEY
2. OPENROUTER_API_KEY
3. OPENAI_API_KEY
4. DASHSCOPE_API_KEY

### 3. 使用场景

**场景1：只配置一个API Key**（最简单）
- 只需在 `.env` 文件中配置一个API Key
- 系统自动检测并使用，无需修改配置文件

**场景2：配置多个API Key**
- 默认使用 `coins_config.json` 中配置的
- 可通过修改配置文件切换模型

**场景3：配置错误自动恢复**
- 如果配置的Key不存在，自动使用其他可用的Key
- 不会因配置错误而启动失败

---

## 📝 配置文件示例

### config/coins_config.json

```json
{
  "ai_config": {
    "provider": "deepseek",
    "model": "deepseek-chat",
    "api_base": "https://api.deepseek.com",
    "api_key_env": "DEEPSEEK_API_KEY",
    "temperature": 0.7,
    "max_tokens": 4000
  }
}
```

### .env 文件

```bash
# DeepSeek（默认）
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxx

# OpenRouter（可选）
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxx

# OpenAI（可选）
OPENAI_API_KEY=sk-xxxxxxxxxxxxx

# Qwen（可选）
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxx
```

---

## 🔄 如何切换模型

### 方式1：修改配置文件（推荐）

1. 编辑 `config/coins_config.json`
2. 修改 `ai_config` 部分
3. 重启程序

### 方式2：只配置.env（最简单）

1. 在 `.env` 中只配置你要用的API Key
2. 直接启动程序（系统会自动检测并使用）

---

## 📚 相关文档

详细配置说明请参考：`docs/AI模型配置说明.md`

---

## 🐛 Bug修复

无

---

## ⚠️ 注意事项

1. **API Key安全**：
   - `.env` 文件不要提交到Git
   - 不要在代码中硬编码API Key

2. **模型成本**：
   - DeepSeek最便宜（0.14¥/百万tokens）
   - OpenRouter价格取决于所选模型
   - OpenAI和Claude相对较贵

3. **向后兼容**：
   - 如果未配置 `ai_config`，使用默认DeepSeek配置
   - 旧的代码逻辑完全兼容

---

## 📦 文件变更

### 新增文件
- `docs/AI模型配置说明.md` - AI模型配置详细文档

### 修改文件
- `config/coins_config.json` - 新增 `ai_config` 配置项
- `src/portfolio_manager.py` - 新增AI配置加载和智能检测逻辑

---

## 🚀 升级步骤

1. 备份当前配置文件（可选）
2. 替换新版本文件
3. 检查 `config/coins_config.json` 是否有 `ai_config` 配置
4. 如果使用新的AI模型，在 `.env` 中添加对应的API Key
5. 重启程序

---

## ✅ 测试建议

1. 测试默认配置（DeepSeek）
2. 测试OpenRouter配置
3. 测试智能检测机制（配置错误的Key，看是否自动fallback）
4. 测试只配置一个Key的情况

